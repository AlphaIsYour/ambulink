<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AmbuLink - Layanan Ambulans Terdekat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Extension Error Suppressor -->
    <script>
        (function() {
            // Aggressive error suppression for extension-related errors
            const originalConsoleError = console.error;
            const suppressPatterns = [
                'The message port closed before a response was received',
                'Unchecked runtime.lastError',
                'Extension context invalidated',
                'Cannot access a chrome',
                'Extension manifest',
                'chrome.runtime'
            ];

            // Override console.error completely
            console.error = function(...args) {
                if (args.length === 0) return;
                
                // Convert all arguments to string for checking
                const errorString = args.map(arg => 
                    typeof arg === 'string' ? arg : 
                    arg instanceof Error ? arg.message :
                    String(arg)
                ).join(' ');

                // Check if error matches any suppress pattern
                if (suppressPatterns.some(pattern => errorString.includes(pattern))) {
                    return; // Silently ignore these errors
                }

                // Pass through other errors
                originalConsoleError.apply(console, args);
            };

            // Intercept and suppress error events
            window.addEventListener('error', function(event) {
                if (suppressPatterns.some(pattern => 
                    (event.error?.message || event.message || '').includes(pattern)
                )) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
            }, true);

            // Intercept and suppress unhandled promise rejection events
            window.addEventListener('unhandledrejection', function(event) {
                if (suppressPatterns.some(pattern => 
                    (event.reason?.message || event.reason || '').includes(pattern)
                )) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
            }, true);

            // Override chrome API if it exists
            if (window.chrome) {
                try {
                    // Create a proxy to intercept chrome API access
                    const chromeProxy = new Proxy({}, {
                        get: function(target, prop) {
                            // Return a no-op function for any method call
                            return function() { return undefined; };
                        }
                    });

                    // Try to override chrome API
                    Object.defineProperty(window, 'chrome', {
                        value: chromeProxy,
                        writable: false,
                        configurable: false
                    });
                } catch (e) {
                    // Silently fail if we can't override chrome
                }
            }

            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                // Attempt to clean up any remaining message ports
                if (window.chrome?.runtime?.connect) {
                    try {
                        const port = chrome.runtime.connect();
                        if (port && port.disconnect) {
                            port.disconnect();
                        }
                    } catch (e) {}
                }
            });
        })();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f8f9fa;
        }

        #map { 
            height: 500px; 
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .ambulance-card {
            transition: all 0.3s ease;
            border: 1px solid #e5e7eb;
        }

        .ambulance-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 9999;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.3s ease-out;
        }

        .location-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 12px;
        }

        .location-button {
            background-color: white;
            color: #AA1919;
            padding: 10px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            border: 1px solid #AA1919;
        }

        .location-button:hover {
            background-color: #AA1919;
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .gradient-bg {
            background: linear-gradient(135deg, #AA1919 0%, #8B0000 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto">
            <div class="flex justify-between items-center h-16 px-4">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center space-x-3">
                        <i class="fas fa-ambulance text-2xl text-[#AA1919]"></i>
                        <span class="text-2xl font-bold text-[#AA1919]">AmbuLink</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="locateMe" class="location-button flex items-center">
                        <i class="fas fa-location-arrow mr-2"></i>
                        Lokasi Saya
                    </button>
                    <a href="/tambah.html" class="location-button flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Tambah Ambulans
                    </a>
                    <button id="logoutBtn" class="text-gray-600 hover:text-[#AA1919] transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Keluar
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="gradient-bg shadow-lg overflow-hidden mb-8">
        <div class="container mx-auto max-w-6xl flex flex-col md:flex-row items-center justify-between px-8 py-16">
            <div class="text-center md:text-left mb-8 md:mb-0 md:w-1/2">
                <h1 class="text-xl md:text-3xl font-bold text-white mb-4">Temukan Ambulans Terdekat</h1>
                <p class="text-gray-100 text-md mb-8">AmbuLink membantu Anda menemukan layanan ambulans terdekat dengan cepat dan mudah. Bandingkan layanan, fasilitas, dan biaya untuk mendapatkan bantuan yang tepat.</p>
                <button onclick="window.location.href='#filter-pencarian'" class="bg-white text-[#AA1919] px-8 py-3 rounded-lg font-medium hover:bg-gray-100 transition-colors flex items-center mx-auto md:mx-0">
                    <span>Mulai Pencarian</span>
                    <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
            <div class="flex justify-center md:w-1/2">
                <img src="images/img.png" alt="Ambulance illustration" class="w-full max-w-md rounded-lg">
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Fitur Utama Section -->
        <div class="mb-16">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-12">Fitur Utama</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- Pencarian Terdekat -->
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                    <div class="bg-red-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mb-6 mx-auto">
                        <i class="fas fa-search text-2xl text-[#AA1919]"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-center mb-4">Pencarian Terdekat</h3>
                    <p class="text-gray-600 text-center">
                        Temukan ambulans terdekat dari lokasi Anda dengan cepat menggunakan peta interaktif
                    </p>
                </div>

                <!-- Pendaftaran Layanan -->
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                    <div class="bg-red-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mb-6 mx-auto">
                        <i class="fas fa-ambulance text-2xl text-[#AA1919]"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-center mb-4">Pendaftaran Layanan</h3>
                    <p class="text-gray-600 text-center">
                        Hubungi langsung penyedia layanan melalui nomor kontak hotline atau WhatsApp
                    </p>
                </div>

                <!-- Informasi Lengkap -->
                <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
                    <div class="bg-red-100 p-4 rounded-full w-16 h-16 flex items-center justify-center mb-6 mx-auto">
                        <i class="fas fa-info-circle text-2xl text-[#AA1919]"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-center mb-4">Informasi Lengkap</h3>
                    <p class="text-gray-600 text-center">
                        Bandingkan harga, fasilitas, dan layanan ambulans untuk mendapatkan bantuan yang tepat
                    </p>
                </div>
            </div>
        </div>

        

        
        <!-- Filter Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 w-full" id="filter-pencarian">
            <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                <i class="fas fa-filter mr-2 text-[#AA1919]"></i>
                Filter Pencarian
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-6">
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Radius Pencarian</label>
                    <select id="filterRadius" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="0">Semua Jarak</option>
                        <option value="1">1 km</option>
                        <option value="3">3 km</option>
                        <option value="5">5 km</option>
                        <option value="10">10 km</option>
                        <option value="25">25 km</option>
                    </select>
                    <p class="mt-1 text-xs text-gray-500">Pilih radius pencarian dari lokasi Anda</p>
                </div>
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Provinsi</label>
                    <select id="filterProvinsi" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="">Semua Provinsi</option>
                    </select>
                </div>
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kota</label>
                    <select id="filterKota" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="">Semua Kota</option>
                    </select>
                </div>
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe Instansi</label>
                    <select id="filterTipe" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="">Semua Tipe</option>
                        <option value="rs">Rumah Sakit</option>
                        <option value="puskesmas">Puskesmas</option>
                        <option value="klinik">Klinik</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Layanan</label>
                    <select id="filterJenisLayanan" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="">Semua Layanan</option>
                        <option value="gawat_darurat">Gawat Darurat</option>
                        <option value="transportasi">Transportasi</option>
                        <option value="lainnya">Lainnya</option>
                    </select>
                </div>
                <div class="group">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status Layanan</label>
                    <select id="filterStatus" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50 transition-all duration-300 hover:border-[#AA1919]">
                        <option value="">Semua Status</option>
                        <option value="gratis">Gratis</option>
                        <option value="berbayar">Berbayar</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- Content Section -->
        <div class="flex flex-col md:flex-row gap-8 mb-16">
            <!-- Map Section -->
            <div class="md:w-2/3">
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div id="map" class="relative w-full" style="z-index: 0; height: calc(100vh - 400px);">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ambulance Cards Section -->
            <div class="md:w-1/3">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div id="ambulanceList" class="grid grid-cols-1 gap-4" style="height: calc(100vh - 400px); overflow-y: auto;">
                        <!-- Cards will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Chart.js -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        
        <!-- Add statistics section after filter section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                <i class="fas fa-chart-bar mr-2 text-[#AA1919]"></i>
                Statistik & Rekomendasi
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Statistik -->
                <div class="col-span-2 grid grid-cols-2 gap-4">
                    <div class="h-48">
                        <canvas id="ambulanceTypeChart"></canvas>
                    </div>
                    <div class="h-48">
                        <canvas id="ambulanceStatusChart"></canvas>
                    </div>
                </div>
                <!-- Rekomendasi Terdekat -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg mb-3 text-[#AA1919]">Ambulans Terdekat</h4>
                    <div id="nearestAmbulance" class="space-y-3">
                        <!-- Will be filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        
    </div>
    <!-- Footer -->
    <footer class="bg-gradient-to-r from-[#AA1919] to-[#8B0000] text-white w-full">
        <div class="max-w-7xl mx-auto px-4 py-12">
            <div class="grid items-start justify-between grid-cols-1 md:grid-cols-4 gap-8 mb-8">
                <div class="space-y-4">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-ambulance text-2xl text-[#fff]"></i>
                        <span class="text-2xl font-bold text-[#fff]">AmbuLink</span>
                    </div>
                    <p class="text-sm">Menghubungkan Anda dengan layanan ambulans terdekat secara cepat dan efisien.</p>
                </div>
                
                <div class="space-y-4">
                    <h4 class="text-xl font-bold">Kontak</h4>
                    <ul class="space-y-2">
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-2"></i>
                            <span>Emergency: 119</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>info@ambulink.id</span>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2"></i>
                            <span>Jakarta, Indonesia</span>
                        </li>
                    </ul>
                </div>

                <div class="space-y-4">
                    <h4 class="text-xl font-bold">Ikuti Kami</h4>
                    <div class="flex space-x-4">
                        <a href="#" class="hover:text-red-200 transition-colors duration-300">
                            <i class="fab fa-facebook-f text-xl"></i>
                        </a>
                        <a href="#" class="hover:text-red-200 transition-colors duration-300">
                            <i class="fab fa-twitter text-xl"></i>
                        </a>
                        <a href="#" class="hover:text-red-200 transition-colors duration-300">
                            <i class="fab fa-instagram text-xl"></i>
                        </a>
                        <a href="#" class="hover:text-red-200 transition-colors duration-300">
                            <i class="fab fa-youtube text-xl"></i>
                        </a>
                    </div>
                </div>
                <div class="space-y-4">
                    <h5 class="text-lg font-semibold mb-2">Survei Kepuasan</h5>
                    <a href="#" class="inline-block bg-white text-[#AA1919] px-4 py-2 rounded-lg hover:bg-red-100 transition-colors duration-300">
                        Beri Feedback
                    </a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Review Modal -->
    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">Beri Review</h3>
            <form id="reviewForm" class="space-y-4">
                <input type="hidden" id="reviewAmbulansId" />
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Rating</label>
                    <div class="flex space-x-2">
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="1">★</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="2">★</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="3">★</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="4">★</button>
                        <button type="button" class="star-btn text-2xl text-gray-300 hover:text-yellow-400" data-rating="5">★</button>
                    </div>
                </div>
                <div>
                    <label for="reviewKomentar" class="block text-sm font-medium text-gray-700 mb-1">Komentar</label>
                    <textarea id="reviewKomentar" rows="3" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-[#AA1919] focus:ring focus:ring-[#AA1919] focus:ring-opacity-50"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeReviewModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                        Batal
                    </button>
                    <button type="submit" class="px-4 py-2 bg-[#AA1919] text-white rounded-lg hover:bg-[#8B0000]">
                        Kirim Review
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Your existing JavaScript code remains unchanged -->
    <script>
        // Suppress Chrome extension errors completely
        window.addEventListener('error', (event) => {
            if (event.error?.message?.includes('The message port closed before a response was received')) {
                event.preventDefault(); // Prevent the error from appearing in console
            }
        });

        // Check authentication
        if (!localStorage.getItem('token')) {
            window.location.href = '/login.html';
        }

        let map = null;
        let markers = [];
        let ambulanceData = [];
        let userMarker = null;
        let userLocation = null;
        let routingControl = null;
        let locationCircle = null; // For accuracy radius
        let isManualLocationMode = false;

        // Custom icons
        const ambulanceIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
         
        const userIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

         // Helper function untuk menampilkan jenis layanan
         function getJenisLayananLabel(value) {
            const labels = {
                'gawat_darurat': 'Gawat Darurat',
                'transportasi': 'Transportasi',
                'lainnya': 'Lainnya'
            };
            return labels[value] || value;
        }

        // Initialize map
        function initMap() {
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add click handler for manual location selection
            map.on('click', function(e) {
                if (isManualLocationMode) {
                    setManualLocation(e.latlng);
                }
            });
        }

        // Set manual location
        function setManualLocation(latlng) {
            userLocation = [latlng.lat, latlng.lng];
            
            if (userMarker) {
                map.removeLayer(userMarker);
            }

            userMarker = L.marker([latlng.lat, latlng.lng], {
                icon: userIcon,
                draggable: true // Allow marker to be dragged
            })
                .addTo(map)
                .bindPopup('Lokasi Anda (drag untuk mengubah)')
                .openPopup();

            // Update location when marker is dragged
            userMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                userLocation = [position.lat, position.lng];
                updateMarkers();
            });

            map.setView([latlng.lat, latlng.lng], 13);
            showToast('Lokasi berhasil dipilih!', 'success');
            isManualLocationMode = false;
            updateMarkers();
            
            // Update cursor style
            document.getElementById('map').style.cursor = '';
        }

        // Get current location
        function getCurrentLocation() {
            showToast('Mencari lokasi Anda...', 'info');

            if (!navigator.geolocation) {
                showToast('Browser Anda tidak mendukung geolokasi. Silakan pilih lokasi manual.', 'error');
                enableManualLocationSelection();
                return;
            }

            // Clear existing location markers
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            if (locationCircle) {
                map.removeLayer(locationCircle);
            }

            // Watchposition untuk mendapatkan update lokasi secara real-time
            const watchId = navigator.geolocation.watchPosition(
                // Success callback
                (position) => {
                    console.log("Data lokasi lengkap:", {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: new Date(position.timestamp).toISOString()
                    });

                    const { latitude, longitude, accuracy } = position.coords;
                    
                    // Validate coordinates
                    if (!isValidCoordinates(latitude, longitude)) {
                        console.error("Koordinat tidak valid:", { latitude, longitude });
                        showToast('Koordinat lokasi tidak valid. Silakan pilih lokasi manual.', 'error');
                        enableManualLocationSelection();
                        return;
                    }

                    // Hanya update jika akurasi cukup baik (kurang dari 100 meter)
                    if (accuracy > 100) {
                        console.log("Menunggu akurasi lebih baik...", accuracy);
                        return;
                    }

                    // Stop watching setelah mendapat lokasi yang akurat
                    navigator.geolocation.clearWatch(watchId);

                    userLocation = [latitude, longitude];

                    // Create user marker with popup showing coordinates and accuracy
                    userMarker = L.marker([latitude, longitude], {
                        icon: userIcon,
                        draggable: true
                    })
                        .addTo(map)
                        .bindPopup(
                            `Lokasi Anda<br>` +
                            `Lat: ${latitude.toFixed(6)}<br>` +
                            `Lng: ${longitude.toFixed(6)}<br>` +
                            `Akurasi: ±${Math.round(accuracy)}m<br>` +
                            `<small>(Drag untuk mengubah)</small>`
                        )
                        .openPopup();

                    // Add accuracy circle dengan radius yang lebih kecil
                    const circleRadius = Math.min(accuracy, 100); // Maksimal radius 100 meter
                    if (locationCircle) {
                        map.removeLayer(locationCircle);
                    }
                    locationCircle = L.circle([latitude, longitude], {
                        radius: circleRadius,
                        color: '#3388ff',
                        fillColor: '#3388ff',
                        fillOpacity: 0.1,
                        weight: 1
                    }).addTo(map);

                    // Update circle when marker is dragged
                    userMarker.on('dragstart', () => {
                        if (locationCircle) {
                            map.removeLayer(locationCircle);
                        }
                    });

                    userMarker.on('dragend', function(event) {
                        const marker = event.target;
                        const position = marker.getLatLng();
                        userLocation = [position.lat, position.lng];
                        
                        // Update marker popup
                        marker.setPopupContent(
                            `Lokasi Anda (Manual)<br>` +
                            `Lat: ${position.lat.toFixed(6)}<br>` +
                            `Lng: ${position.lng.toFixed(6)}`
                        );
                        
                        saveLastLocation(userLocation);
                        updateMarkers();
                        updateNearestAmbulance();
                    });

                    // Zoom to user location
                    map.setView([latitude, longitude], 15);
                    
                    showToast(`Lokasi ditemukan! (Akurasi: ±${Math.round(accuracy)}m)`, 'success');
                    saveLastLocation(userLocation);
                    updateMarkers();
                    updateNearestAmbulance();

                    // Bring user marker to front
                    if (userMarker && typeof userMarker.bringToFront === 'function') {
                        try {
                            userMarker.bringToFront();
                        } catch (error) {
                            console.warn('Could not bring user marker to front:', error);
                        }
                    }
                },
                // Error callback
                (error) => {
                    console.error("Error detail lokasi:", {
                        code: error.code,
                        message: error.message,
                        PERMISSION_DENIED: error.PERMISSION_DENIED,
                        POSITION_UNAVAILABLE: error.POSITION_UNAVAILABLE,
                        TIMEOUT: error.TIMEOUT
                    });

                    let errorMessage = 'Gagal mendapatkan lokasi: ';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Izin lokasi ditolak. Pastikan GPS aktif dan izin lokasi diizinkan di browser Anda.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Informasi lokasi tidak tersedia. Pastikan GPS aktif dan koneksi internet stabil.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Waktu permintaan lokasi habis. Coba refresh halaman atau gunakan pilih lokasi manual.';
                            break;
                        default:
                            errorMessage += error.message;
                    }
                    
                    showToast(errorMessage, 'error');
                    tryLoadLastLocation() || enableManualLocationSelection();
                },
                // Options
                {
                    enableHighAccuracy: true, // Gunakan GPS untuk akurasi tinggi
                    timeout: 15000, // Timeout 15 detik
                    maximumAge: 0 // Selalu minta posisi baru
                }
            );

            // Timeout untuk watchPosition
            setTimeout(() => {
                navigator.geolocation.clearWatch(watchId);
                if (!userLocation) {
                    showToast('Tidak dapat mendapatkan lokasi yang akurat. Silakan pilih lokasi manual.', 'error');
                    enableManualLocationSelection();
                }
            }, 15000);
        }

        // Validate coordinates
        function isValidCoordinates(lat, lng) {
            return !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && 
                   lng >= -180 && lng <= 180;
        }

        // Save last known location
        function saveLastLocation(location) {
            try {
                localStorage.setItem('lastLocation', JSON.stringify(location));
            } catch (e) {
                console.error('Error saving location:', e);
            }
        }

        // Try to load last known location
        function tryLoadLastLocation() {
            try {
                const lastLocation = localStorage.getItem('lastLocation');
                if (lastLocation) {
                    const [lat, lng] = JSON.parse(lastLocation);
                    if (isValidCoordinates(lat, lng)) {
                        userLocation = [lat, lng];
                        userMarker = L.marker(userLocation, {
                            icon: userIcon,
                            draggable: true
                        })
                            .addTo(map)
                            .bindPopup('Lokasi terakhir Anda (drag untuk mengubah)')
                            .openPopup();

                        map.setView(userLocation, 13);
                        updateMarkers();
                        showToast('Menggunakan lokasi terakhir yang tersimpan', 'info');
                        return true;
                    }
                }
            } catch (e) {
                console.error('Error loading last location:', e);
            }
            return false;
        }

        // Enable manual location selection
        function enableManualLocationSelection() {
            isManualLocationMode = true;
            document.getElementById('map').style.cursor = 'crosshair';
            showToast('Klik pada peta untuk memilih lokasi Anda', 'info');
        }

        // Handle location button click
        document.getElementById('locateMe').addEventListener('click', () => {
            getCurrentLocation();
        });

        // Clean up function
        function cleanupMap() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            
            markers.forEach(marker => {
                if (marker) {
                    map.removeLayer(marker);
                }
            });
            markers = [];
            
            if (userMarker) {
                map.removeLayer(userMarker);
                userMarker = null;
            }
        }

        // Show toast message
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${
                type === 'error' ? 'bg-red-100 text-red-700' :
                type === 'success' ? 'bg-green-100 text-green-700' :
                'bg-blue-100 text-blue-700'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize map first
            initMap();
            
            // Load provinsi data
            loadProvinsiData();
            
            // Get user location and load ambulances
            await getCurrentLocation();
            await loadAmbulanceData();
            
            // Set up filter event listeners
            document.getElementById('filterProvinsi').addEventListener('change', handleFilterChange);
            document.getElementById('filterKota').addEventListener('change', handleFilterChange);
            document.getElementById('filterTipe').addEventListener('change', handleFilterChange);
            document.getElementById('filterJenisLayanan').addEventListener('change', handleFilterChange);
            document.getElementById('filterStatus').addEventListener('change', handleFilterChange);
            document.getElementById('filterRadius').addEventListener('change', () => {
                updateRadiusVisualization();
                handleFilterChange();
            });
            
            // Add this line after loadAmbulanceData()
            updateNearestAmbulance();
            
            // Update recommendation when location changes
            if (userMarker) {
                userMarker.on('dragend', updateNearestAmbulance);
            }
        });

        // Handle filter changes
        function handleFilterChange() {
            updateCards();
            updateMarkers();
        }

        // Get route to ambulance
        function getRoute(destination, name) {
            if (!userLocation) {
                showToast('Aktifkan lokasi Anda terlebih dahulu', 'error');
                return;
            }

            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(userLocation[0], userLocation[1]),
                    L.latLng(destination[0], destination[1])
                ],
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                lineOptions: {
                    styles: [{ color: '#AA1919', weight: 6 }]
                },
                createMarker: function() { return null; },
                show: false,
                routeWhileDragging: false,
                addWaypoints: false,
                fitSelectedRoutes: true
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const route = routes[0];
                const distance = (route.summary.totalDistance/1000).toFixed(1);
                const duration = Math.round(route.summary.totalTime/60);
                
                // Create route info modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-route text-[#AA1919] mr-2"></i>
                            Rute ke ${name}
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-road w-8"></i>
                                <span>Jarak: ${distance} km</span>
                            </div>
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-clock w-8"></i>
                                <span>Estimasi waktu: ${duration} menit</span>
                            </div>
                            <div class="flex items-center text-gray-700">
                                <i class="fas fa-info-circle w-8"></i>
                                <span class="text-sm">*Estimasi waktu dapat berubah tergantung kondisi lalu lintas</span>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            });
        }

        // Load ambulance data
        async function loadAmbulanceData() {
            try {
                const response = await fetch('/api/ambulans', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch ambulance data');
                }

                ambulanceData = await response.json();
                console.log('Data dari database:', ambulanceData);
                
                // Pastikan data yang diterima adalah array
                if (!Array.isArray(ambulanceData)) {
                    if (ambulanceData.data && Array.isArray(ambulanceData.data)) {
                        ambulanceData = ambulanceData.data;
                    } else {
                        throw new Error('Data format is invalid');
                    }
                }

                updateFilters();
                updateCards();
                updateMarkers();
                updateStatistics();
            } catch (error) {
                console.error('Error loading ambulance data:', error);
                showToast('Gagal memuat data ambulans: ' + error.message, 'error');
            }
        }

        // Function to create ambulance card
        function createAmbulanceCard(ambulance) {
            console.log('Creating card for ambulance:', ambulance); // Debug log
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg p-6 ambulance-card';
            
            const distance = userLocation ? calculateDistance(userLocation, [ambulance.latitude, ambulance.longitude]) : null;
            const fasilitas = Array.isArray(ambulance.fasilitas) ? 
                ambulance.fasilitas : 
                (typeof ambulance.fasilitas === 'string' ? JSON.parse(ambulance.fasilitas || '[]') : []);
            
            // Format rating jika ada
            const rating = ambulance.rating ? Number(ambulance.rating) : 0;
            const jumlahRating = ambulance.jumlah_rating || 0;
            const ratingDisplay = rating > 0 ? 
                `<span class="font-medium">${rating.toFixed(1)}</span>
                 <i class="fas fa-star"></i>
                 <span class="text-gray-500">(${jumlahRating})</span>` : 
                'Belum ada rating';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold">${ambulance.nama || ''}</h3>
                    <div class="text-yellow-400 text-sm">
                        ${ratingDisplay}
                    </div>
                </div>
                <p class="text-gray-600 mb-2">
                    <i class="fas fa-map-marker-alt text-red-500 mr-2"></i>
                    ${ambulance.alamat || ''}, ${ambulance.kota || ''}, ${ambulance.provinsi || ''}
                </p>
                <div class="space-y-2 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-phone text-green-500 w-5"></i>
                        <a href="tel:${ambulance.kontak}" class="text-blue-600 hover:text-blue-800 ml-2">
                            ${ambulance.kontak}
                        </a>
                    </div>
                    <div class="flex items-center">
                        <i class="fab fa-whatsapp text-[#25D366] w-5"></i>
                        ${ambulance.whatsapp ? 
                            `<a href="https://wa.me/${ambulance.whatsapp.replace(/\D/g,'')}" target="_blank" 
                                class="text-blue-600 hover:text-blue-800 ml-2">
                                ${ambulance.whatsapp}
                            </a>` : 
                            `<span class="text-gray-500 ml-2">-</span>`
                        }
                    </div>
                    ${ambulance.jam_operasional ? `
                    <div class="flex items-center">
                        <i class="fas fa-clock text-blue-500 w-5"></i>
                        <span class="ml-2">${ambulance.jam_operasional}</span>
                    </div>
                    ` : ''}
                </div>
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <a href="tel:${ambulance.kontak}" 
                       class="flex items-center justify-center bg-green-500 text-white px-3 py-2 rounded text-center hover:bg-green-600 transition-colors">
                        <i class="fas fa-phone mr-2"></i>Telepon
                    </a>
                    ${ambulance.whatsapp ? 
                        `<a href="https://wa.me/${ambulance.whatsapp.replace(/\D/g,'')}" target="_blank" 
                            class="flex items-center justify-center bg-[#25D366] text-white px-3 py-2 rounded text-center hover:bg-[#128C7E] transition-colors">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </a>` :
                        `<button disabled class="flex items-center justify-center bg-gray-300 text-white px-3 py-2 rounded text-center cursor-not-allowed">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </button>`
                    }
                </div>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex items-center">
                        <i class="fas fa-building w-5"></i>
                        <span>${getTipeInstansiLabel(ambulance.tipe_instansi) || ''}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-ambulance w-5"></i>
                        <span>${getJenisLayananLabel(ambulance.jenis_layanan) || ''}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-${ambulance.status === 'gratis' ? 'hand-holding-heart text-green-500' : 'money-bill'} w-5"></i>
                        <span>${ambulance.status === 'gratis' ? 'Gratis' : formatPrice(ambulance.harga || 0)}</span>
                    </div>
                    ${distance ? `
                    <div class="flex items-center">
                        <i class="fas fa-route w-5"></i>
                        <span>${distance} km dari lokasi Anda</span>
                    </div>
                    ` : ''}
                </div>
                ${ambulance.deskripsi ? `
                <div class="mt-4 text-sm text-gray-600">
                    <p class="italic">"${ambulance.deskripsi}"</p>
                </div>
                ` : ''}
                ${fasilitas.length > 0 ? `
                <div class="border-t pt-4 mt-4">
                    <h4 class="font-medium mb-2">Fasilitas:</h4>
                    <div class="flex flex-wrap gap-2">
                        ${fasilitas.map(f => `
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                ${f}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                <div class="mt-4 space-y-2">
                    ${userLocation ? `
                    <button onclick="getRoute([${ambulance.latitude}, ${ambulance.longitude}], '${ambulance.nama}')" 
                            class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors">
                        <i class="fas fa-directions mr-2"></i>Lihat Rute
                    </button>
                    ` : ''}
                    <button onclick="showReviewModal(${ambulance.id})"
                            class="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded hover:bg-gray-200 transition-colors">
                        <i class="fas fa-star mr-2"></i>Beri Review
                    </button>
                </div>
            `;
            return card;
        }

        // Update popup content
        function createPopupContent(ambulans) {
            const popupContent = document.createElement('div');
            popupContent.className = 'p-4';
            popupContent.style.maxWidth = '300px';
            
            const distance = userLocation ? calculateDistance(userLocation, [ambulans.latitude, ambulans.longitude]) : null;
            
            // Format rating jika ada
            const rating = ambulans.rating ? Number(ambulans.rating) : 0;
            const jumlahRating = ambulans.jumlah_rating || 0;
            const ratingDisplay = rating > 0 ? 
                `<div class="flex items-center text-yellow-400 mb-2">
                    <span class="font-medium">${rating.toFixed(1)}</span>
                    <i class="fas fa-star ml-1"></i>
                    <span class="text-gray-500 ml-1">(${jumlahRating})</span>
                </div>` : '';
            
            popupContent.innerHTML = `
                <div class="text-lg font-bold mb-2">${ambulans.nama}</div>
                ${ratingDisplay}
                <div class="space-y-2 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-phone text-green-500 w-5"></i>
                        <a href="tel:${ambulans.kontak}" class="hover:text-blue-500 ml-2">${ambulans.kontak}</a>
                    </div>
                    <div class="flex items-center">
                        <i class="fab fa-whatsapp text-[#25D366] w-5"></i>
                        ${ambulans.whatsapp ? 
                            `<a href="https://wa.me/${ambulans.whatsapp.replace(/\D/g,'')}" target="_blank" 
                                class="hover:text-blue-500 ml-2">
                                ${ambulans.whatsapp}
                            </a>` : 
                            `<span class="text-gray-500 ml-2">-</span>`
                        }
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-building text-blue-500 w-5"></i>
                        <span class="ml-2">${getTipeInstansiLabel(ambulans.tipe_instansi) || 'Tidak tersedia'}</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-${ambulans.status === 'gratis' ? 'hand-holding-heart text-green-500' : 'money-bill text-blue-500'} w-5"></i>
                        <span class="ml-2">${ambulans.status === 'gratis' ? 'Gratis' : formatPrice(ambulans.harga || 0)}</span>
                    </div>
                    ${distance ? `
                    <div class="flex items-center">
                        <i class="fas fa-route text-blue-500 w-5"></i>
                        <span class="ml-2">${distance} km dari lokasi Anda</span>
                    </div>
                    ` : ''}
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <a href="tel:${ambulans.kontak}" 
                       class="flex items-center justify-center bg-green-500 text-white px-3 py-2 rounded text-center hover:bg-green-600 transition-colors text-sm">
                        <i class="fas fa-phone mr-2"></i>Telepon
                    </a>
                    ${ambulans.whatsapp ? 
                        `<a href="https://wa.me/${ambulans.whatsapp.replace(/\D/g,'')}" target="_blank" 
                            class="flex items-center justify-center bg-[#25D366] text-white px-3 py-2 rounded text-center hover:bg-[#128C7E] transition-colors text-sm">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </a>` :
                        `<button disabled class="flex items-center justify-center bg-gray-300 text-white px-3 py-2 rounded text-center cursor-not-allowed text-sm">
                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                        </button>`
                    }
                </div>
                ${userLocation ? `
                <button onclick="getRoute([${ambulans.latitude}, ${ambulans.longitude}], '${ambulans.nama}')" 
                        class="w-full mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors text-sm">
                    <i class="fas fa-directions mr-2"></i>Lihat Rute
                </button>
                ` : ''}
            `;
            
            return popupContent;
        }

        // Update markers
        function updateMarkers() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Get filtered data
            const filteredData = filterAmbulanceData();
            console.log('Filtered ambulance data:', filteredData);
            
            // Add new markers for filtered data only
            filteredData.forEach(ambulans => {
                if (ambulans.latitude && ambulans.longitude) {
                    const marker = L.marker([ambulans.latitude, ambulans.longitude], {
                        icon: ambulanceIcon
                    });
                    
                    // Store ambulance data in marker
                    marker.ambulansData = ambulans;
                    
                    // Create and bind popup
                    marker.bindPopup(() => createPopupContent(ambulans));
                    
                    marker.addTo(map);
                    markers.push(marker);
                }
            });

            // Fit bounds only if no user location is set
            if (markers.length > 0 && !userLocation) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds(), {
                    padding: [50, 50]
                });
            }

            // Bring user marker to front if it exists and is a valid Leaflet marker
            if (userMarker && typeof userMarker.bringToFront === 'function') {
                try {
                    userMarker.bringToFront();
                } catch (error) {
                    console.warn('Could not bring user marker to front:', error);
                }
            }
        }

        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            const R = 6371; // Earth's radius in km
            const lat1 = point1[0] * Math.PI / 180;
            const lat2 = point2[0] * Math.PI / 180;
            const deltaLat = (point2[0] - point1[0]) * Math.PI / 180;
            const deltaLon = (point2[1] - point1[1]) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLon/2) * Math.sin(deltaLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        // Function to format price
        function formatPrice(price) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(price);
        }

        // Update cards
        function updateCards() {
            const container = document.getElementById('ambulanceList');
            container.innerHTML = '';

            const filteredData = filterAmbulanceData();
            console.log('Updating cards with filtered data:', filteredData);

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <p class="text-gray-500">Tidak ada ambulans yang sesuai dengan filter yang dipilih</p>
                    </div>
                `;
                return;
            }

            filteredData.forEach(ambulance => {
                container.appendChild(createAmbulanceCard(ambulance));
            });
        }

        // Filter functions
        function filterAmbulanceData() {
            const provinsi = document.getElementById('filterProvinsi').value;
            const kota = document.getElementById('filterKota').value;
            const tipe = document.getElementById('filterTipe').value;
            const jenisLayanan = document.getElementById('filterJenisLayanan').value;
            const status = document.getElementById('filterStatus').value;
            const radius = parseFloat(document.getElementById('filterRadius').value);

            return ambulanceData.filter(ambulance => {
                // Filter berdasarkan provinsi
                if (provinsi && ambulance.provinsi !== provinsi) return false;
                
                // Filter berdasarkan kota
                if (kota && ambulance.kota !== kota) return false;
                
                // Filter berdasarkan tipe instansi
                if (tipe && ambulance.tipe_instansi !== tipe) return false;
                
                // Filter berdasarkan jenis layanan
                if (jenisLayanan && ambulance.jenis_layanan !== jenisLayanan) return false;
                
                // Filter berdasarkan status layanan
                if (status && ambulance.status !== status) return false;

                // Filter berdasarkan radius jika ada lokasi user dan radius dipilih
                if (userLocation && radius > 0) {
                    const distance = calculateDistance(userLocation, [ambulance.latitude, ambulance.longitude]);
                    if (distance > radius) return false;
                }
                
                return true;
            });
        }

        // Load provinsi dan kota dari API
        const WILAYAH_API = {
            PROVINSI: [
                { id: '11', name: 'ACEH' },
                { id: '12', name: 'SUMATERA UTARA' },
                { id: '13', name: 'SUMATERA BARAT' },
                { id: '14', name: 'RIAU' },
                { id: '15', name: 'JAMBI' },
                { id: '16', name: 'SUMATERA SELATAN' },
                { id: '17', name: 'BENGKULU' },
                { id: '18', name: 'LAMPUNG' },
                { id: '19', name: 'KEPULAUAN BANGKA BELITUNG' },
                { id: '21', name: 'KEPULAUAN RIAU' },
                { id: '31', name: 'DKI JAKARTA' },
                { id: '32', name: 'JAWA BARAT' },
                { id: '33', name: 'JAWA TENGAH' },
                { id: '34', name: 'DI YOGYAKARTA' },
                { id: '35', name: 'JAWA TIMUR' },
                { id: '36', name: 'BANTEN' },
                { id: '51', name: 'BALI' },
                { id: '52', name: 'NUSA TENGGARA BARAT' },
                { id: '53', name: 'NUSA TENGGARA TIMUR' },
                { id: '61', name: 'KALIMANTAN BARAT' },
                { id: '62', name: 'KALIMANTAN TENGAH' },
                { id: '63', name: 'KALIMANTAN SELATAN' },
                { id: '64', name: 'KALIMANTAN TIMUR' },
                { id: '65', name: 'KALIMANTAN UTARA' },
                { id: '71', name: 'SULAWESI UTARA' },
                { id: '72', name: 'SULAWESI TENGAH' },
                { id: '73', name: 'SULAWESI SELATAN' },
                { id: '74', name: 'SULAWESI TENGGARA' },
                { id: '75', name: 'GORONTALO' },
                { id: '76', name: 'SULAWESI BARAT' },
                { id: '81', name: 'MALUKU' },
                { id: '82', name: 'MALUKU UTARA' },
                { id: '91', name: 'PAPUA BARAT' },
                { id: '94', name: 'PAPUA' }
            ]
        };

        function loadProvinsiData() {
            const provinsiSelect = document.getElementById('filterProvinsi');
            provinsiSelect.innerHTML = '<option value="">Semua Provinsi</option>';
            
            WILAYAH_API.PROVINSI.forEach(province => {
                const option = document.createElement('option');
                option.value = province.name;
                option.textContent = province.name;
                provinsiSelect.appendChild(option);
            });
        }

        // Function to get coordinates from city name
        async function getCoordinates(cityName, provinceName) {
            try {
                const query = `${cityName}, ${provinceName}, Indonesia`;
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        boundingbox: data[0].boundingbox
                    };
                }
                return null;
            } catch (error) {
                console.error('Error getting coordinates:', error);
                return null;
            }
        }

        // Function to center map on selected city
        async function centerMapOnCity(cityName, provinceName) {
            const coords = await getCoordinates(cityName, provinceName);
            if (coords) {
                // Get markers in the selected city
                const cityMarkers = markers.filter(marker => {
                    const ambulans = marker.ambulansData;
                    return ambulans && ambulans.kota === cityName;
                });

                if (cityMarkers.length > 0) {
                    // Create a bounds object that includes all markers in the city
                    const group = L.featureGroup(cityMarkers);
                    map.fitBounds(group.getBounds(), {
                        padding: [50, 50], // Add some padding around the bounds
                        maxZoom: 13 // Limit maximum zoom level
                    });
                } else {
                    // If no markers in the city, use coordinates from geocoding
                    map.setView([coords.lat, coords.lon], 13);
                }

                // Show toast message
                showToast(`Peta dipusatkan ke ${cityName}, ${provinceName}`, 'success');
            }
        }

        // Update filter options
        function updateFilters() {
            const provinsiSelect = document.getElementById('filterProvinsi');
            const kotaSelect = document.getElementById('filterKota');
            const selectedProvinsi = provinsiSelect.value;

            // Reset kota filter when provinsi changes
            if (provinsiSelect.dataset.lastValue !== selectedProvinsi) {
                kotaSelect.innerHTML = '<option value="">Semua Kota</option>';
                provinsiSelect.dataset.lastValue = selectedProvinsi;
            }

            // Show all unique cities from ambulance data
            const kotaSet = new Set();
            ambulanceData.forEach(ambulance => {
                if (selectedProvinsi) {
                    // If province is selected, only show cities from that province
                    if (ambulance.provinsi.toUpperCase() === selectedProvinsi && ambulance.kota) {
                        kotaSet.add(ambulance.kota);
                    }
                } else {
                    // If no province selected, show all cities
                    if (ambulance.kota) {
                        kotaSet.add(ambulance.kota);
                    }
                }
            });

            // Update kota options
            const currentKota = kotaSelect.value;
            kotaSelect.innerHTML = '<option value="">Semua Kota</option>';
            Array.from(kotaSet).sort().forEach(kota => {
                const option = document.createElement('option');
                option.value = kota;
                option.textContent = kota;
                if (kota === currentKota) {
                    option.selected = true;
                }
                kotaSelect.appendChild(option);
            });

            // Update cards and map
            updateCards();
            updateMarkers();
        }

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // Helper function untuk menampilkan tipe instansi
        function getTipeInstansiLabel(value) {
            const labels = {
                'rs': 'Rumah Sakit',
                'puskesmas': 'Puskesmas',
                'klinik': 'Klinik',
                'lainnya': 'Lainnya'
            };
            return labels[value] || value;
        }

        // Add radius circle visualization
        let radiusCircle = null;

        function updateRadiusVisualization() {
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
            }

            const radius = parseFloat(document.getElementById('filterRadius').value);
            if (userLocation && radius > 0) {
                radiusCircle = L.circle(userLocation, {
                    radius: radius * 1000, // Convert km to meters
                    color: '#AA1919',
                    fillColor: '#AA1919',
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(map);
            }
        }

        // Add statistics functions
        function updateStatistics() {
            updateAmbulanceTypeChart();
            updateAmbulanceStatusChart();
        }

        function updateAmbulanceTypeChart() {
            const typeCount = {};
            ambulanceData.forEach(ambulance => {
                typeCount[ambulance.tipe_instansi] = (typeCount[ambulance.tipe_instansi] || 0) + 1;
            });

            const ctx = document.getElementById('ambulanceTypeChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(typeCount).map(type => getTipeInstansiLabel(type)),
                    datasets: [{
                        data: Object.values(typeCount),
                        backgroundColor: [
                            '#AA1919',
                            '#DC2626',
                            '#EF4444',
                            '#F87171'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribusi Tipe Ambulans'
                        }
                    }
                }
            });
        }

        function updateAmbulanceStatusChart() {
            const statusCount = {
                gratis: 0,
                berbayar: 0
            };
            ambulanceData.forEach(ambulance => {
                statusCount[ambulance.status]++;
            });

            const ctx = document.getElementById('ambulanceStatusChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Gratis', 'Berbayar'],
                    datasets: [{
                        data: Object.values(statusCount),
                        backgroundColor: [
                            '#059669',
                            '#AA1919'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Status Layanan Ambulans'
                        }
                    }
                }
            });
        }

        // Add nearest ambulance recommendation
        function updateNearestAmbulance() {
            const container = document.getElementById('nearestAmbulance');
            if (!userLocation || !ambulanceData.length) {
                container.innerHTML = '<p class="text-gray-500">Aktifkan lokasi untuk melihat rekomendasi</p>';
                return;
            }

            // Calculate distances and sort
            const withDistance = ambulanceData.map(ambulance => ({
                ...ambulance,
                distance: calculateDistance(userLocation, [ambulance.latitude, ambulance.longitude])
            }))
            .filter(a => a.distance <= 5) // Only within 5km
            .sort((a, b) => a.distance - b.distance)
            .slice(0, 3); // Take top 3

            if (withDistance.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Tidak ada ambulans dalam radius 5km</p>';
                return;
            }

            container.innerHTML = withDistance.map(ambulance => `
                <div class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="font-medium text-[#AA1919]">${ambulance.nama}</div>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-route mr-1"></i> ${ambulance.distance.toFixed(1)} km
                    </div>
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-phone mr-1"></i> ${ambulance.kontak}
                    </div>
                    <div class="mt-2">
                        <button onclick="getRoute([${ambulance.latitude}, ${ambulance.longitude}], '${ambulance.nama}')"
                                class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition-colors">
                            <i class="fas fa-directions mr-1"></i>Rute
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Add review functions
        function showReviewModal(ambulansId) {
            document.getElementById('reviewModal').classList.remove('hidden');
            document.getElementById('reviewModal').classList.add('flex');
            document.getElementById('reviewAmbulansId').value = ambulansId;
            
            // Reset form
            document.querySelectorAll('.star-btn').forEach(btn => {
                btn.classList.remove('text-yellow-400');
                btn.classList.add('text-gray-300');
            });
            document.getElementById('reviewKomentar').value = '';
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
            document.getElementById('reviewModal').classList.remove('flex');
        }

        // Star rating functionality
        document.querySelectorAll('.star-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const rating = parseInt(e.target.dataset.rating);
                document.querySelectorAll('.star-btn').forEach((star, index) => {
                    if (index < rating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            });
        });

        // Handle review submission
        document.getElementById('reviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ambulansId = document.getElementById('reviewAmbulansId').value;
            const rating = document.querySelectorAll('.star-btn.text-yellow-400').length;
            const komentar = document.getElementById('reviewKomentar').value;

            if (rating === 0) {
                showToast('Silakan beri rating terlebih dahulu', 'error');
                return;
            }

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        ambulans_id: ambulansId,
                        rating,
                        komentar
                    })
                });

                if (!response.ok) {
                    throw new Error('Gagal mengirim review');
                }

                showToast('Review berhasil dikirim', 'success');
                closeReviewModal();
                loadAmbulanceData(); // Refresh data
            } catch (error) {
                console.error('Error submitting review:', error);
                showToast('Gagal mengirim review', 'error');
            }
        });
    </script>
</body>
</html>     